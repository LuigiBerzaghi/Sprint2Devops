# Azure Pipelines para Trackyard

trigger:
  - main
  - sprint4

variables:
  - group: trackyard-secrets
  - name: RG_NAME
    value: 'rg-trackyard'
  - name: APP_NAME
    value: 'trackyard-2TDSB'
  - name: ACR_NAME
    value: 'acrtrackyard'
  - name: vmImage
    value: 'ubuntu-latest'
  - name: dockerRegistryServiceConnection
    value: 'acrTrackyard'
  - name: azureSubscription
    value: 'azureTrackyard'

stages:
  - stage: CI
    displayName: 'CI - Build, Test e Imagem'
    jobs:
      - job: Build
        displayName: 'Build Java e Push da Imagem no ACR'
        pool:
          vmImage: $(vmImage)
        steps:
          - checkout: self
            persistCredentials: false

          - task: Maven@3
            displayName: 'Maven clean test package'
            inputs:
              mavenPomFile: 'trackyard/pom.xml'
              goals: 'clean test package'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'

          - task: Docker@2
            displayName: 'Docker buildAndPush -> ACR (latest + commit hash)'
            inputs:
              command: 'buildAndPush'
              containerRegistry: '$(dockerRegistryServiceConnection)'
              repository: 'trackyard'
              Dockerfile: 'trackyard/Dockerfile'
              buildContext: 'trackyard'
              tags: |
                $(Build.SourceVersion)
                latest

          - task: PublishBuildArtifacts@1
            displayName: 'Publicar artefato opcional (.jar)'
            condition: succeeded()
            inputs:
              PathtoPublish: 'trackyard/target'
              ArtifactName: 'java_package'
              publishLocation: 'Container'

  - stage: CD
    displayName: 'CD - Deploy para Azure Web App (Container)'
    dependsOn: CI
    condition: succeeded()
    jobs:
      - job: Deploy
        displayName: 'Configurar Web App para usar a imagem do commit'
        pool:
          vmImage: $(vmImage)
        steps:
          - task: AzureCLI@2
            displayName: 'az webapp config container set (imagem do commit)'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -euo pipefail

                IMAGE_TAG="$(Build.SourceVersion)"
                IMAGE_NAME="$(ACR_NAME).azurecr.io/trackyard:${IMAGE_TAG}"

                echo "Definindo Web App $(APP_NAME) para imagem ${IMAGE_NAME}"

                az webapp config container set \
                  --resource-group "$(RG_NAME)" \
                  --name "$(APP_NAME)" \
                  --docker-custom-image-name "${IMAGE_NAME}" \
                  --docker-registry-server-url "https://$(ACR_NAME).azurecr.io" \
                  --docker-registry-server-user "$(ACR_USERNAME)" \
                  --docker-registry-server-password "$(ACR_PASSWORD)"
