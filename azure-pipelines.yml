# Azure Pipelines para Trackyard

trigger:
  - main
  - sprint4
  - master

variables:
  - group: trackyard-secrets
  - name: RG_NAME
    value: 'rg-trackyard'
  - name: APP_NAME
    value: 'trackyard-2TDSB'
  - name: ACR_NAME
    value: 'acrtrackyard'
  - name: vmImage
    value: 'ubuntu-latest'
  - name: SQL_SERVER_NAME
    value: 'sqltrackyard'
  - name: SQL_DB_NAME
    value: 'dbtrackyard'
  - name: SQL_ADMIN_USER
    value: 'adminuser'
  - name: dockerRegistryServiceConnection
    value: 'acrTrackyard'
  - name: azureSubscription
    value: 'azureTrackyard'

stages:
  - stage: CI
    displayName: 'CI - Build, Test e Imagem'
    jobs:
      - job: Build
        displayName: 'Build Java e Push da Imagem no ACR'
        pool:
          vmImage: $(vmImage)
        steps:
          - checkout: self
            persistCredentials: false

          - script: |
              set -euo pipefail
              jdbc="jdbc:sqlserver://$(SQL_SERVER_NAME).database.windows.net:1433;database=$(SQL_DB_NAME);user=$(SQL_ADMIN_USER)@$(SQL_SERVER_NAME);password=$(SQL_ADMIN_PASSWORD);encrypt=true;trustServerCertificate=false;loginTimeout=30;"
              echo "##vso[task.setvariable variable=SPRING_DATASOURCE_URL;issecret=true]$jdbc"
              echo "##vso[task.setvariable variable=SPRING_DATASOURCE_USERNAME]$(SQL_ADMIN_USER)"
              echo "##vso[task.setvariable variable=SPRING_DATASOURCE_PASSWORD;issecret=true]$(SQL_ADMIN_PASSWORD)"
              echo "##vso[task.setvariable variable=SPRING_DATASOURCE_DRIVER_CLASS_NAME]com.microsoft.sqlserver.jdbc.SQLServerDriver"
            displayName: 'Definir variaveis de conexao com Azure SQL'
            env:
              SQL_ADMIN_PASSWORD: $(SQL_ADMIN_PASSWORD)

          - task: Maven@3
            displayName: 'Maven clean test package'
            inputs:
              mavenPomFile: 'trackyard/pom.xml'
              goals: 'clean test package'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
            env:
              SPRING_DATASOURCE_URL: $(SPRING_DATASOURCE_URL)
              SPRING_DATASOURCE_USERNAME: $(SPRING_DATASOURCE_USERNAME)
              SPRING_DATASOURCE_PASSWORD: $(SPRING_DATASOURCE_PASSWORD)
              SPRING_DATASOURCE_DRIVER_CLASS_NAME: $(SPRING_DATASOURCE_DRIVER_CLASS_NAME)

          - task: Docker@2
            displayName: 'Docker buildAndPush -> ACR (latest + commit hash)'
            inputs:
              command: 'buildAndPush'
              containerRegistry: '$(dockerRegistryServiceConnection)'
              repository: 'trackyard'
              Dockerfile: 'trackyard/Dockerfile'
              buildContext: 'trackyard'
              tags: |
                $(Build.SourceVersion)
                latest

          - task: PublishBuildArtifacts@1
            displayName: 'Publicar artefato opcional (.jar)'
            condition: succeeded()
            inputs:
              PathtoPublish: 'trackyard/target'
              ArtifactName: 'java_package'
              publishLocation: 'Container'

  - stage: CD
    displayName: 'CD - Deploy para Azure Web App (Container)'
    dependsOn: CI
    condition: succeeded()
    jobs:
      - job: Deploy
        displayName: 'Configurar Web App para usar a imagem do commit'
        pool:
          vmImage: $(vmImage)
        steps:
          - task: AzureCLI@2
            displayName: 'az webapp config container set (imagem do commit)'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -euo pipefail

                IMAGE_TAG="$(Build.SourceVersion)"
                IMAGE_NAME="$(ACR_NAME).azurecr.io/trackyard:${IMAGE_TAG}"

                echo "Definindo Web App $(APP_NAME) para imagem ${IMAGE_NAME}"

                az webapp config container set \
                  --resource-group "$(RG_NAME)" \
                  --name "$(APP_NAME)" \
                  --docker-custom-image-name "${IMAGE_NAME}" \
                  --docker-registry-server-url "https://$(ACR_NAME).azurecr.io" \
                  --docker-registry-server-user "$(ACR_USERNAME)" \
                  --docker-registry-server-password "$(ACR_PASSWORD)"
